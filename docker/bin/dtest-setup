#!/usr/bin/env bash

set -ex

# find the aws instance IP and set the $SSH_CONN,
# then wait for AWS instance to be up
set -o allexport
source ./bin/instance-wait-for
set +o allexport

${SSH_CONN} "if cd cassandra-dtest; then git pull; else git clone https://github.com/apache/cassandra-dtest.git; fi"

# TESTING ONLY
#${SSH_CONN} "sudo rm -rf cassandra-dtest; git clone https://github.com/joaquincasares/cassandra-dtest-1.git cassandra-dtest"
#${SSH_CONN} "cd cassandra-dtest; git checkout parallel-docker-dtests"

${SSH_CONN} "touch cassandra-dtest/docker/secrets.env"
${SSH_CONN} "cd cassandra-dtest; docker-compose build unittests dtests"
${SSH_CONN} "cd cassandra-dtest; docker-compose run unittests"

cd cassandra-dtest
for file in *.py
do
    ${SSH_CONN} "docker-compose run -d dtests apache trunk $file"
done

rsync -avzhe ssh --progress -i ${KEYPAIR_PATH} ${AMI_USER}@${INSTANCE_IP}:cassandra-dtest/results/ results/
