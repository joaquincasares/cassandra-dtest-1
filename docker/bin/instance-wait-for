#!/usr/bin/env bash

set -ex

# check a specific directory, or the default directory
CHECK_DIRECTORY=${1:-.}

# find all instances that share the same $INSTANCE_NAME, but assume one IP
INSTANCE_IP=$(aws ec2 describe-instances \
                  --filters Name=tag:Name,Values="${INSTANCE_NAME}" \
                      | jq '.Reservations[].Instances[].PublicIpAddress' \
                      | grep -v null \
                      | sed 's/"//g')

# define the ssh connection string
SSH_CONN="ssh -i ${KEYPAIR_PATH} ${AMI_USER}@${INSTANCE_IP}"

# wait for the machine to come up
while :
do
    # don't use strict host checking now, since we'll do that after we confirm
    # that the instance is online
    ${SSH_CONN} \
        -o UserKnownHostsFile=/dev/null \
        -o StrictHostKeyChecking=no \
        "ls ${CHECK_DIRECTORY}" \
        && break \
    || echo "Waiting for instance to come online..." \
        && sleep 10
done

# auto-accept the ssh keypair
mkdir -p ~/.ssh
ssh-keyscan -t ecdsa ${INSTANCE_IP} > ~/.ssh/known_hosts
